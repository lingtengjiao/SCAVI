"""
FastAPI åç«¯ - å·¥å‚å†…è¡£å®˜ç½‘ B2B å±•ç¤ºç³»ç»Ÿ
ä½¿ç”¨ SQLAlchemy (Async) + SQLAdmin + MySQL
"""
from fastapi import FastAPI, Depends, HTTPException
from fastapi.responses import HTMLResponse
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine, async_sessionmaker
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column, relationship
from sqlalchemy import String, Text, Integer, Boolean, ForeignKey, JSON
from sqladmin import Admin, ModelView
from sqladmin.authentication import AuthenticationBackend
from starlette.requests import Request
from starlette.responses import RedirectResponse
from starlette.middleware.sessions import SessionMiddleware
from typing import Optional, List
from pydantic import BaseModel
import os
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ==================== æ•°æ®åº“é…ç½® ====================
DATABASE_URL = (
    f"mysql+aiomysql://{os.getenv('DB_USER', 'root')}:{os.getenv('DB_PASSWORD', 'suantian51')}"
    f"@{os.getenv('DB_HOST', '127.0.0.1')}:{os.getenv('DB_PORT', '3306')}"
    f"/{os.getenv('DB_NAME', 'SCAVI')}?charset=utf8mb4"
)

engine = create_async_engine(DATABASE_URL, echo=True)
async_session_maker = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

# ==================== SQLAlchemy Base ====================
class Base(DeclarativeBase):
    pass

# ==================== Models ====================
class Category(Base):
    """äº§å“åˆ†ç±» - ç»´åº¦è¡¨ï¼ˆå•çº§åˆ†ç±»ï¼Œæç®€ç‰ˆï¼‰"""
    __tablename__ = "categories"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String(100), nullable=False, comment="åˆ†ç±»åç§°")
    slug: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, comment="URL æ ‡è¯†")
    order: Mapped[int] = mapped_column(Integer, default=0, comment="æ’åºæƒé‡")
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, comment="æ˜¯å¦å¯ç”¨")
    
    # å…³è”å…³ç³»
    products: Mapped[List["Product"]] = relationship("Product", back_populates="category")

    def __repr__(self):
        return f"<Category(id={self.id}, name='{self.name}')>"


class Product(Base):
    """äº§å“ - B2B å±•ç¤º"""
    __tablename__ = "products"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    category_id: Mapped[Optional[int]] = mapped_column(ForeignKey("categories.id"), nullable=True, comment="åˆ†ç±»ID")
    name: Mapped[str] = mapped_column(String(200), nullable=False, comment="äº§å“åç§°")
    slug: Mapped[Optional[str]] = mapped_column(String(200), unique=True, nullable=True, comment="URL æ ‡è¯†")
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True, comment="äº§å“ç®€ä»‹")
    key_features: Mapped[Optional[str]] = mapped_column(Text, nullable=True, comment="æ ¸å¿ƒå–ç‚¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰")
    # ä½¿ç”¨ JSON å­—æ®µå­˜å‚¨å›¾ç‰‡åˆ—è¡¨å’Œè§„æ ¼å‚æ•°ï¼ˆç®€åŒ–è®¾è®¡ï¼‰
    images: Mapped[Optional[List[str]]] = mapped_column(JSON, nullable=True, comment="å›¾ç‰‡URLåˆ—è¡¨")
    specs: Mapped[Optional[dict]] = mapped_column(JSON, nullable=True, comment="è§„æ ¼å‚æ•°ï¼ˆé¢œè‰²ã€å°ºç ã€æè´¨ç­‰ï¼‰")
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, comment="æ˜¯å¦å±•ç¤º")
    created_at: Mapped[Optional[str]] = mapped_column(String(50), nullable=True, comment="åˆ›å»ºæ—¶é—´")
    updated_at: Mapped[Optional[str]] = mapped_column(String(50), nullable=True, comment="æ›´æ–°æ—¶é—´")
    
    # å…³è”å…³ç³»
    category: Mapped[Optional["Category"]] = relationship("Category", back_populates="products")

    def __repr__(self):
        return f"<Product(id={self.id}, name='{self.name}')>"


# ==================== SQLAdmin è®¤è¯ ====================
class AdminAuth(AuthenticationBackend):
    """ç®€å•çš„è®¤è¯åç«¯ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ç”¨æˆ·åå¯†ç ï¼‰"""
    async def login(self, request: Request) -> bool:
        form = await request.form()
        username = form.get("username")
        password = form.get("password")
        
        # ç®€å•çš„è®¤è¯é€»è¾‘ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼‰
        if username == os.getenv("ADMIN_USERNAME", "SCAVI") and password == os.getenv("ADMIN_PASSWORD", "SCAVI123"):
            request.session.update({"authenticated": True})
            return True
        return False

    async def logout(self, request: Request) -> bool:
        request.session.clear()
        return True

    async def authenticate(self, request: Request) -> bool:
        return request.session.get("authenticated", False)


# ==================== SQLAdmin Views ====================
class CategoryAdmin(ModelView, model=Category):
    """åˆ†ç±»ç®¡ç†"""
    name = "åˆ†ç±»"
    name_plural = "åˆ†ç±»ç®¡ç†"
    icon = "fa-folder"
    
    column_list = [Category.id, Category.name, Category.slug, Category.order, Category.is_active]
    column_searchable_list = [Category.name]
    column_sortable_list = [Category.id, Category.name, Category.order]
    column_default_sort = ("order", True)
    form_columns = [Category.name, Category.slug, Category.order, Category.is_active]


class ProductAdmin(ModelView, model=Product):
    """äº§å“ç®¡ç†"""
    name = "äº§å“"
    name_plural = "äº§å“ç®¡ç†"
    icon = "fa-box"
    
    column_list = [Product.id, Product.name, Product.category, Product.is_active, Product.created_at]
    column_searchable_list = [Product.name, Product.description]
    column_sortable_list = [Product.id, Product.name, Product.created_at]
    column_default_sort = ("id", False)
    form_columns = [
        Product.name,
        Product.slug,
        Product.category,
        Product.description,
        Product.key_features,
        Product.images,
        Product.specs,
        Product.is_active
    ]


# ==================== FastAPI App ====================
app = FastAPI(
    title="SCAVI å·¥å‚å†…è¡£å®˜ç½‘ API",
    description="B2B äº§å“å±•ç¤ºç³»ç»Ÿ",
    version="1.0.0"
)

# æ·»åŠ  Session ä¸­é—´ä»¶ï¼ˆSQLAdmin è®¤è¯éœ€è¦ï¼‰
app.add_middleware(SessionMiddleware, secret_key=os.getenv("SECRET_KEY", "your-secret-key-here"))

# ==================== SQLAdmin é…ç½® ====================
authentication_backend = AdminAuth(secret_key=os.getenv("SECRET_KEY", "your-secret-key-here"))
admin = Admin(app, engine, authentication_backend=authentication_backend)
admin.add_view(CategoryAdmin)
admin.add_view(ProductAdmin)

# ==================== æ•°æ®åº“ä¾èµ– ====================
async def get_db():
    """è·å–æ•°æ®åº“ä¼šè¯"""
    async with async_session_maker() as session:
        yield session

# ==================== Pydantic Schemas ====================
class CategoryResponse(BaseModel):
    id: int
    name: str
    slug: str
    order: int
    is_active: bool
    
    class Config:
        from_attributes = True


class ProductResponse(BaseModel):
    id: int
    name: str
    slug: Optional[str]
    description: Optional[str]
    key_features: Optional[str]
    images: Optional[List[str]]
    specs: Optional[dict]
    is_active: bool
    category_id: Optional[int]
    category: Optional[CategoryResponse] = None
    
    class Config:
        from_attributes = True


# ==================== API è·¯ç”± ====================
@app.get("/", response_class=HTMLResponse)
async def root():
    """é¦–é¡µ"""
    return """
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SCAVI å·¥å‚å†…è¡£å®˜ç½‘ API</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
            .container {
                background: white;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                padding: 40px;
                max-width: 600px;
                width: 100%;
                text-align: center;
            }
            h1 { color: #333; margin-bottom: 10px; font-size: 32px; }
            .subtitle { color: #666; margin-bottom: 40px; font-size: 16px; }
            .links { display: flex; flex-direction: column; gap: 16px; }
            .link {
                display: block;
                padding: 16px 24px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-decoration: none;
                border-radius: 8px;
                font-size: 18px;
                font-weight: 500;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .link:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            }
            .link.secondary {
                background: #f5f5f5;
                color: #333;
            }
            .link.secondary:hover {
                background: #e8e8e8;
                box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸš€ SCAVI API</h1>
            <p class="subtitle">FastAPI + SQLAdmin åç«¯ç³»ç»Ÿ</p>
            <div class="links">
                <a href="/admin" class="link">è¿›å…¥ç®¡ç†åå°</a>
                <a href="/docs" class="link secondary">æŸ¥çœ‹ API æ–‡æ¡£</a>
            </div>
        </div>
    </body>
    </html>
    """


@app.get("/api/categories", response_model=List[CategoryResponse])
async def get_categories(db: AsyncSession = Depends(get_db)):
    """è·å–åˆ†ç±»åˆ—è¡¨"""
    from sqlalchemy import select
    result = await db.execute(select(Category).where(Category.is_active == True).order_by(Category.order))
    categories = result.scalars().all()
    return categories


@app.get("/api/products", response_model=List[ProductResponse])
async def get_products(
    category_id: Optional[int] = None,
    db: AsyncSession = Depends(get_db)
):
    """è·å–äº§å“åˆ—è¡¨ï¼ˆæ”¯æŒæŒ‰åˆ†ç±»è¿‡æ»¤ï¼‰"""
    from sqlalchemy import select
    query = select(Product).where(Product.is_active == True)
    
    if category_id:
        query = query.where(Product.category_id == category_id)
    
    query = query.order_by(Product.id.desc())
    result = await db.execute(query)
    products = result.scalars().all()
    return products


@app.get("/api/products/{product_id}", response_model=ProductResponse)
async def get_product(product_id: int, db: AsyncSession = Depends(get_db)):
    """è·å–äº§å“è¯¦æƒ…"""
    from sqlalchemy import select
    result = await db.execute(select(Product).where(Product.id == product_id))
    product = result.scalar_one_or_none()
    
    if not product:
        raise HTTPException(status_code=404, detail="äº§å“ä¸å­˜åœ¨")
    
    return product


# ==================== å¯åŠ¨æ—¶åˆ›å»ºè¡¨ ====================
@app.on_event("startup")
async def startup():
    """å¯åŠ¨æ—¶åˆ›å»ºæ•°æ®åº“è¡¨"""
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    print("âœ… æ•°æ®åº“è¡¨å·²åˆ›å»º")


@app.on_event("shutdown")
async def shutdown():
    """å…³é—­æ—¶æ¸…ç†"""
    await engine.dispose()
    print("âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­")

